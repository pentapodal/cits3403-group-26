{% extends "base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1 class="story-title">{{ current_user.username }}'s Overshare!</h1>
  <div id="story-box" class="story-box" style="position:relative;">
    <span id="typewriter"></span>
    <button id="skip-btn" class="btn btn-secondary skip-btn">Skip</button>
  </div>

  <div id="data-table" class="data-table" style="opacity:0; transition: opacity 1s;">
    <h2>Your Year in Review</h2>
    <table class="table table-striped">
      <tbody>
        <tr>
          <td>Total Liked Posts</td>
          <td>{{ user_data.total_liked_posts }}</td>
        </tr>
        <tr>
          <td>Top 3 Most Liked Accounts for Posts</td>
          <td>
            {% if user_data.top_3_most_liked_account_for_posts and user_data.top_3_most_liked_account_for_posts|length > 0 %}
              <ul>
                {% for account in user_data.top_3_most_liked_account_for_posts %}
                  <li><strong>{{ account.name }}</strong> ({{ account.liked_posts_count }} likes)</li>
                {% endfor %}
              </ul>
            {% else %}
              No data found
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>Total Liked Comments</td>
          <td>{{ user_data.total_liked_comments }}</td>
        </tr>
        <tr>
          <td>Top 3 Most Liked Accounts for Comments</td>
          <td>
            {% if user_data.top_3_most_liked_account_for_comments and user_data.top_3_most_liked_account_for_comments|length > 0 %}
              <ul>
                {% for account in user_data.top_3_most_liked_account_for_comments %}
                  <li><strong>{{ account.name }}</strong> ({{ account.liked_comments_count }} likes)</li>
                {% endfor %}
              </ul>
            {% else %}
              No data found
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>Total Liked Stories</td>
          <td>{{ user_data.total_liked_stories }}</td>
        </tr>
        <tr>
          <td>Top 3 Most Liked Accounts for Stories</td>
          <td>
            {% if user_data.top_3_most_liked_account_for_stories and user_data.top_3_most_liked_account_for_stories|length > 0 %}
              <ul>
                {% for account in user_data.top_3_most_liked_account_for_stories %}
                  <li><strong>{{ account.name }}</strong> ({{ account.story_activities_story_likes }} likes)</li>
                {% endfor %}
              </ul>
            {% else %}
              No data found
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>Total Posts Commented</td>
          <td>{{ user_data.total_posts_comments }}</td>
        </tr>
        <tr>
          <td>Top 3 Most Commented Accounts for Posts</td>
          <td>
            {% if user_data.top_3_most_commented_accounts_for_posts and user_data.top_3_most_commented_accounts_for_posts|length > 0 %}
              <ul>
                {% for account in user_data.top_3_most_commented_accounts_for_posts %}
                  <li><strong>{{ account.name }}</strong> ({{ account.comment_count }} comments)</li>
                {% endfor %}
              </ul>
            {% else %}
              No data found
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>Total Reels Commented</td>
          <td>{{ user_data.total_reels_comments }}</td>
        </tr>
        <tr>
          <td>Top 3 Most Commented Accounts for Reels</td>
          <td>
            {% if user_data.top_3_most_commented_accounts_for_reels and user_data.top_3_most_commented_accounts_for_reels|length > 0 %}
              <ul>
                {% for account in user_data.top_3_most_commented_accounts_for_reels %}
                  <li><strong>{{ account.name }}</strong> ({{ account.comment_count }} comments)</li>
                {% endfor %}
              </ul>
            {% else %}
              No data found
            {% endif %}
          </td>
        </tr>
        <tr>
          <td>Total Stories Posted</td>
          <td>{{ user_data.total_stories_posted }}</td>
        </tr>
        <tr>
          <td>Total People Messaged</td>
          <td>{{ user_data.total_people_messaged }}</td>
        </tr>
        <tr>
          <td>Top 3 Most Messaged People</td>
          <td>
            {% if user_data.top_3_most_messaged_people and user_data.top_3_most_messaged_people|length > 0 %}
              <ul>
                {% for person in user_data.top_3_most_messaged_people %}
                  <li><strong>{{ person.name }}</strong> ({{ person.message_count }} messages)</li>
                {% endfor %}
              </ul>
            {% else %}
              No data found
            {% endif %}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Prepare story steps
  const storySteps = [
    `First thing in the morning, before you even had your coffee, you were on Instagram. Sound familiar? Over the past year, 
    youâ€™ve liked a staggering {{ user_data.total_liked_posts }} post(s). Thatâ€™s a lot of double taps!
    {% if user_data.top_3_most_liked_account_for_posts %} 
      And because you <em>definitely</em> have favorites, here are the accounts you couldnâ€™t stop liking:
      <ul>
        {% for account in user_data.top_3_most_liked_account_for_posts %}
          <li>{{ account.name }} ({{ account.liked_posts_count }} like(s))</li>
        {% endfor %}
      </ul>
    {% else %}
      Looks like you played it coolâ€”no likes to be found. Are you okay?
    {% endif %}`,

    `You werenâ€™t just scrolling, you were engaging. This year, youâ€™ve liked {{ user_data.total_liked_comments }} comment(s).
    Yes, even the ones that just said "ðŸ”¥" or "same."
    {% if user_data.top_3_most_liked_account_for_comments %}
      Here are the accounts whose comments got your seal of approval:
      <ul>
        {% for account in user_data.top_3_most_liked_account_for_comments %}
          <li>{{ account.name }} ({{ account.liked_comments_count }} like(s))</li>
        {% endfor %}
      </ul>
    {% else %}
      No liked comments? Youâ€™re missing out on the wildest part of Instagram.
    {% endif %}`,

    `But wait, thereâ€™s more. You didnâ€™t just like other peopleâ€™s commentsâ€”you made your 
    own voice heard, commenting on {{ user_data.total_posts_comments }} post(s) this year.
    {% if user_data.top_3_most_commented_accounts_for_posts %}
      Hereâ€™s where your comments landed the most:
      <ul>
        {% for account in user_data.top_3_most_commented_accounts_for_posts %}
          <li>{{ account.name }} ({{ account.comment_count }} comment(s))</li>
        {% endfor %}
      </ul>
    {% else %}
      No comments? Silent scrolling is so 2015.
    {% endif %}`,

    `Ah, Storiesâ€”Instagramâ€™s version of a fleeting diary. This year, youâ€™ve liked {{ user_data.total_liked_stories }} stories.
    Youâ€™re practically the friend we all want hyping us up.
    {% if user_data.top_3_most_liked_account_for_stories %}
      Hereâ€™s who kept you tapping that heart:
      <ul>
        {% for account in user_data.top_3_most_liked_account_for_stories %}
          <li>{{ account.name }} ({{ account.story_activities_story_likes }} like(s))</li>
        {% endfor %}
      </ul>
    {% else %}
      No story likes? Missed out on some quality vacation pics and latte art.
    {% endif %}`,

    `If reels are Instagramâ€™s candy, youâ€™ve got a sweet tooth. This year, youâ€™ve commented on {{ user_data.total_reels_comments }} 
    reel(s) â€” from KBBQ temptations to dance challenges you swore youâ€™d learn.
    {% if user_data.top_3_most_commented_accounts_for_reels %}
      Here are the reels you couldnâ€™t resist commenting on:
      <ul>
        {% for account in user_data.top_3_most_commented_accounts_for_reels %}
          <li>{{ account.name }} ({{ account.comment_count }} comment(s))</li>
        {% endfor %}
      </ul>
    {% else %}
      No reel comments? Not even on those satisfying cake-cutting videos? 
    {% endif %}`,

    `Of course, Instagram isnâ€™t just about consuming contentâ€”itâ€™s about sharing it. This year, 
    you posted {{ user_data.total_stories_posted }} stories of your own.`,

    `Finally, letâ€™s talk DMs. You messaged {{ user_data.total_people_messaged }} people this year.
    Weâ€™re not saying youâ€™re addicted to gossip, but the numbers donâ€™t lie.
    {% if user_data.top_3_most_messaged_people %}
      Hereâ€™s who heard from you the most:
      <ul>
        {% for person in user_data.top_3_most_messaged_people %}
          <li>{{ person.name }} ({{ person.message_count }} messages)</li>
        {% endfor %}
      </ul>
    {% else %}
      No messages? Donâ€™t leave your friends on read all year!
    {% endif %}`
  ];

  // Typewriter effect
  const storyBox = document.getElementById("story-box");
  const typewriter = document.getElementById("typewriter");
  const dataTable = document.getElementById("data-table");
  let step = 0;

  function typeWriterEffect(text, i, cb) {
    if (i < text.length) {
      typewriter.innerHTML += text.charAt(i);
      setTimeout(() => typeWriterEffect(text, i + 1, cb), 30);
    } else if (cb) {
      cb();
    }
  }

  function showStoryStep() {
    typewriter.innerHTML = "";
    // Fade in HTML tags (ul/li) instantly, not typewriter
    let html = storySteps[step];
    // Split at first <ul> if present
    let ulIndex = html.indexOf("<ul>");
    if (ulIndex !== -1) {
      let beforeUl = html.substring(0, ulIndex);
      let afterUl = html.substring(ulIndex);
      typeWriterEffect(beforeUl, 0, () => {
        typewriter.innerHTML += afterUl;
        setTimeout(nextStep, 3500);
      });
    } else {
      typeWriterEffect(html, 0, () => setTimeout(nextStep, 4500));
    }
  }

  function nextStep() {
    step++;
    if (step < storySteps.length) {
      showStoryStep();
    } else {
      // Fade out story box, fade in table
      storyBox.style.transition = "opacity 1s";
      storyBox.style.opacity = 0;
      setTimeout(() => {
        storyBox.style.display = "none";
        dataTable.style.opacity = 1;
      }, 1000);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    showStoryStep();
  });

  document.getElementById("skip-btn").onclick = function() {
    storyBox.style.transition = "opacity 1s";
    storyBox.style.opacity = 0;
    setTimeout(() => {
      storyBox.style.display = "none";
      dataTable.style.opacity = 1;
    }, 1000);
  };
</script>
{% endblock %}
